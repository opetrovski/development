description: The Heat Orchestration template used for the creation and provisioning of a stack.

parameters:
  az:
    type: string
    description: availability zone
    default: jp-west-1a
  flavor:
    type: string
    description: flavor
    default: P-1
  ImageId:
    description: The id of the image to provision.
    type: string
    default: ffa17298-537d-40b2-a848-0a4d22b49df5
  KeyName:
    description: The name of an already defined key pair in OpenStack, used for enabling SSH access to the web server.
    type: string
    default: mp_keypair_1a
  network:
    type: string
    description: internal network uuid
    default: 2b918126-6b5b-4b5b-af56-057084173476
  sg_name:
    type: string
    description: security group
    default: mp_sec_gr

resources:
#foreach( $id in $identifier )
  Sys-vol$id:
    type: OS::Cinder::Volume
    properties:
      size: 3
      volume_type: "M1"
      availability_zone: { get_param: az}
      image: {get_param: ImageId}

  vm$id:
    type: OS::Nova::Server
    properties:
      flavor: {get_param: flavor}
      key_name: {get_param: KeyName}
      image: {get_param: ImageId}
      block_device_mapping: [{"volume_size": 3, "volume_id": {get_resource: Sys-vol$id}, "delete_on_termination": True, "device_name": "/dev/vda"}]
      availability_zone: { get_param: az}
      networks: ["uuid": {get_param: network}]
      security_groups: [{get_param: sg_name}]
#end

outputs:
  KP_Out:
    description: Key pair name
    value: {get_param: KeyName}
  IP_Out:
    description: IP Address of the access host
    value: {get_attr: [vm1, networks, private, 0]}
